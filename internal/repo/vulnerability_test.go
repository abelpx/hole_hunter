package repo

import (
	"context"
	"testing"
	"time"

	"github.com/holehunter/holehunter/internal/models"
)

// setupTestVulnerabilityRepo 创建测试用的漏洞仓库
func setupTestVulnerabilityRepo(t *testing.T) (repo *VulnerabilityRepository, cleanup func()) {
	t.Helper()

	db := setupTestDB(t)
	repo = NewVulnerabilityRepository(db)

	cleanup = func() {
		db.Close()
	}

	return repo, cleanup
}

// insertTestVulnerabilities 插入测试漏洞数据
func insertTestVulnerabilities(t *testing.T, repo *VulnerabilityRepository, count int) {
	t.Helper()

	ctx := context.Background()
	now := time.Now().Format(time.RFC3339)

	severities := []string{"critical", "high", "medium", "low", "info"}
	tags := []string{"cwe", "xss", "sqli", "rce", "lfi"}

	for i := 1; i <= count; i++ {
		vuln := &models.Vulnerability{
			TaskID:        1,
			TemplateID:    "test-template",
			Severity:      severities[i%len(severities)],
			Name:          "Test Vulnerability",
			Description:   "This is a test vulnerability",
			URL:           "https://example.com/vuln",
			MatchedAt:     now,
			Tags:          []string{tags[i%len(tags)]},
			FalsePositive: i%10 == 0, // 每10个标记一个误报
			CreatedAt:     now,
		}

		if err := repo.Create(ctx, vuln); err != nil {
			t.Fatalf("failed to insert test vulnerability: %v", err)
		}
	}
}

func TestVulnerabilityRepository_GetPage(t *testing.T) {
	repo, cleanup := setupTestVulnerabilityRepo(t)
	defer cleanup()

	ctx := context.Background()
	totalCount := 150

	t.Run("插入测试数据", func(t *testing.T) {
		insertTestVulnerabilities(t, repo, totalCount)
	})

	t.Run("第1页 - 50条", func(t *testing.T) {
		result, total, err := repo.GetPage(ctx, 1, 50)
		if err != nil {
			t.Fatalf("GetPage() error = %v", err)
		}
		if total != totalCount {
			t.Errorf("GetPage() total = %v, want %v", total, totalCount)
		}
		if len(result) != 50 {
			t.Errorf("GetPage() len(result) = %v, want 50", len(result))
		}
	})

	t.Run("第2页 - 50条", func(t *testing.T) {
		result, total, err := repo.GetPage(ctx, 2, 50)
		if err != nil {
			t.Fatalf("GetPage() error = %v", err)
		}
		if total != totalCount {
			t.Errorf("GetPage() total = %v, want %v", total, totalCount)
		}
		if len(result) != 50 {
			t.Errorf("GetPage() len(result) = %v, want 50", len(result))
		}
	})

	t.Run("第3页 - 剩余50条", func(t *testing.T) {
		result, total, err := repo.GetPage(ctx, 3, 50)
		if err != nil {
			t.Fatalf("GetPage() error = %v", err)
		}
		if total != totalCount {
			t.Errorf("GetPage() total = %v, want %v", total, totalCount)
		}
		if len(result) != 50 {
			t.Errorf("GetPage() len(result) = %v, want 50", len(result))
		}
	})

	t.Run("第4页 - 超出范围返回空", func(t *testing.T) {
		result, total, err := repo.GetPage(ctx, 4, 50)
		if err != nil {
			t.Fatalf("GetPage() error = %v", err)
		}
		if total != totalCount {
			t.Errorf("GetPage() total = %v, want %v", total, totalCount)
		}
		if len(result) != 0 {
			t.Errorf("GetPage() len(result) = %v, want 0", len(result))
		}
	})

	t.Run("小页面大小", func(t *testing.T) {
		result, total, err := repo.GetPage(ctx, 1, 10)
		if err != nil {
			t.Fatalf("GetPage() error = %v", err)
		}
		if total != totalCount {
			t.Errorf("GetPage() total = %v, want %v", total, totalCount)
		}
		if len(result) != 10 {
			t.Errorf("GetPage() len(result) = %v, want 10", len(result))
		}
	})
}

func TestVulnerabilityRepository_GetPageByFilter(t *testing.T) {
	repo, cleanup := setupTestVulnerabilityRepo(t)
	defer cleanup()

	ctx := context.Background()
	totalCount := 150

	t.Run("插入测试数据", func(t *testing.T) {
		insertTestVulnerabilities(t, repo, totalCount)
	})

	t.Run("按严重程度过滤 - critical", func(t *testing.T) {
		filter := &models.VulnerabilityFilter{
			Severity: []string{"critical"},
		}
		result, total, err := repo.GetPageByFilter(ctx, filter, 1, 50)
		if err != nil {
			t.Fatalf("GetPageByFilter() error = %v", err)
		}
		if total == 0 {
			t.Errorf("GetPageByFilter() total = %v, want > 0", total)
		}
		if len(result) == 0 {
			t.Errorf("GetPageByFilter() len(result) = %v, want > 0", len(result))
		}
		for _, v := range result {
			if v.Severity != "critical" {
				t.Errorf("GetPageByFilter() returned severity = %v, want critical", v.Severity)
			}
		}
	})

	t.Run("按多个严重程度过滤", func(t *testing.T) {
		filter := &models.VulnerabilityFilter{
			Severity: []string{"critical", "high"},
		}
		result, total, err := repo.GetPageByFilter(ctx, filter, 1, 50)
		if err != nil {
			t.Fatalf("GetPageByFilter() error = %v", err)
		}
		if total == 0 {
			t.Errorf("GetPageByFilter() total = %v, want > 0", total)
		}
		for _, v := range result {
			if v.Severity != "critical" && v.Severity != "high" {
				t.Errorf("GetPageByFilter() returned severity = %v, want critical or high", v.Severity)
			}
		}
	})

	t.Run("按误报过滤", func(t *testing.T) {
		filter := &models.VulnerabilityFilter{
			IsFalsePositive: func() *bool { b := true; return &b }(),
		}
		result, total, err := repo.GetPageByFilter(ctx, filter, 1, 50)
		if err != nil {
			t.Fatalf("GetPageByFilter() error = %v", err)
		}
		if total == 0 {
			t.Errorf("GetPageByFilter() total = %v, want > 0", total)
		}
		for _, v := range result {
			if !v.FalsePositive {
				t.Errorf("GetPageByFilter() returned false_positive = %v, want true", v.FalsePositive)
			}
		}
	})

	t.Run("按搜索关键词过滤", func(t *testing.T) {
		filter := &models.VulnerabilityFilter{
			Search: "Vulnerability",
		}
		result, total, err := repo.GetPageByFilter(ctx, filter, 1, 50)
		if err != nil {
			t.Fatalf("GetPageByFilter() error = %v", err)
		}
		if total == 0 {
			t.Errorf("GetPageByFilter() total = %v, want > 0", total)
		}
		for _, v := range result {
			if v.Name != "Test Vulnerability" && v.Description != "This is a test vulnerability" {
				t.Errorf("GetPageByFilter() search returned unexpected result: %v", v.Name)
			}
		}
	})

	t.Run("组合过滤条件", func(t *testing.T) {
		filter := &models.VulnerabilityFilter{
			Severity: []string{"high"},
			Search:   "Vulnerability",
		}
		result, _, err := repo.GetPageByFilter(ctx, filter, 1, 50)
		if err != nil {
			t.Fatalf("GetPageByFilter() error = %v", err)
		}
		for _, v := range result {
			if v.Severity != "high" {
				t.Errorf("GetPageByFilter() returned severity = %v, want high", v.Severity)
			}
			if v.Name != "Test Vulnerability" && v.Description != "This is a test vulnerability" {
				t.Errorf("GetPageByFilter() search returned unexpected result: %v", v.Name)
			}
		}
	})
}

// 基准测试 - 使用 helper 创建测试环境
func BenchmarkVulnerabilityRepository_GetPage(b *testing.B) {
	db, err := CreateInMemoryDB()
	if err != nil {
		b.Fatalf("failed to create test db: %v", err)
	}
	defer db.Close()

	repo := NewVulnerabilityRepository(db)
	ctx := context.Background()

	// 插入测试数据
	now := time.Now().Format(time.RFC3339)
	severities := []string{"critical", "high", "medium", "low", "info"}
	for i := 1; i <= 1000; i++ {
		vuln := &models.Vulnerability{
			TaskID:        1,
			TemplateID:    "test-template",
			Severity:      severities[i%len(severities)],
			Name:          "Test Vulnerability",
			Description:   "This is a test vulnerability",
			URL:           "https://example.com/vuln",
			MatchedAt:     now,
			Tags:          []string{"test"},
			FalsePositive: false,
			CreatedAt:     now,
		}
		if err := repo.Create(ctx, vuln); err != nil {
			b.Fatalf("failed to insert test vulnerability: %v", err)
		}
	}

	b.ResetTimer()
	for i := 0; i < b.N; i++ {
		_, _, _ = repo.GetPage(ctx, 1, 50)
	}
}

func BenchmarkVulnerabilityRepository_GetPageByFilter(b *testing.B) {
	db, err := CreateInMemoryDB()
	if err != nil {
		b.Fatalf("failed to create test db: %v", err)
	}
	defer db.Close()

	repo := NewVulnerabilityRepository(db)
	ctx := context.Background()

	// 插入测试数据
	now := time.Now().Format(time.RFC3339)
	severities := []string{"critical", "high", "medium", "low", "info"}
	for i := 1; i <= 1000; i++ {
		vuln := &models.Vulnerability{
			TaskID:        1,
			TemplateID:    "test-template",
			Severity:      severities[i%len(severities)],
			Name:          "Test Vulnerability",
			Description:   "This is a test vulnerability",
			URL:           "https://example.com/vuln",
			MatchedAt:     now,
			Tags:          []string{"test"},
			FalsePositive: false,
			CreatedAt:     now,
		}
		if err := repo.Create(ctx, vuln); err != nil {
			b.Fatalf("failed to insert test vulnerability: %v", err)
		}
	}

	filter := &models.VulnerabilityFilter{
		Severity: []string{"high", "critical"},
		Search:   "Vulnerability",
	}

	b.ResetTimer()
	for i := 0; i < b.N; i++ {
		_, _, _ = repo.GetPageByFilter(ctx, filter, 1, 50)
	}
}
