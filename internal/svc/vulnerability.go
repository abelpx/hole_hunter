package svc

import (
	"context"
	"strings"

	"github.com/holehunter/holehunter/internal/infrastructure/errors"
	"github.com/holehunter/holehunter/internal/models"
	"github.com/holehunter/holehunter/internal/repo"
)

// VulnerabilityService 漏洞服务
type VulnerabilityService struct {
	repo *repo.VulnerabilityRepository
}

// NewVulnerabilityService 创建漏洞服务
func NewVulnerabilityService(repo *repo.VulnerabilityRepository) *VulnerabilityService {
	return &VulnerabilityService{repo: repo}
}

// GetAll 获取所有漏洞
func (s *VulnerabilityService) GetAll(ctx context.Context) ([]*models.Vulnerability, error) {
	return s.repo.GetAll(ctx)
}

// GetByTaskID 根据任务 ID 获取漏洞列表
func (s *VulnerabilityService) GetByTaskID(ctx context.Context, taskID int) ([]*models.Vulnerability, error) {
	if taskID <= 0 {
		return nil, errors.InvalidInput("invalid task id")
	}
	return s.repo.GetByTaskID(ctx, taskID)
}

// GetByID 根据 ID 获取漏洞
func (s *VulnerabilityService) GetByID(ctx context.Context, id int) (*models.Vulnerability, error) {
	if id <= 0 {
		return nil, errors.InvalidInput("invalid vulnerability id")
	}
	return s.repo.GetByID(ctx, id)
}

// MarkFalsePositive 标记误报
func (s *VulnerabilityService) MarkFalsePositive(ctx context.Context, id int, falsePositive bool) error {
	if id <= 0 {
		return errors.InvalidInput("invalid vulnerability id")
	}
	return s.repo.UpdateFalsePositive(ctx, id, falsePositive)
}

// UpdateNotes 更新备注
func (s *VulnerabilityService) UpdateNotes(ctx context.Context, id int, notes string) error {
	if id <= 0 {
		return errors.InvalidInput("invalid vulnerability id")
	}
	return s.repo.UpdateNotes(ctx, id, notes)
}

// Create 创建漏洞
func (s *VulnerabilityService) Create(ctx context.Context, vuln *models.Vulnerability) error {
	return s.repo.Create(ctx, vuln)
}

// Delete 删除漏洞
func (s *VulnerabilityService) Delete(ctx context.Context, id int) error {
	if id <= 0 {
		return errors.InvalidInput("invalid vulnerability id")
	}
	return s.repo.Delete(ctx, id)
}

// GetStats 获取漏洞统计
func (s *VulnerabilityService) GetStats(ctx context.Context) (*VulnStats, error) {
	counts, err := s.repo.CountBySeverity(ctx)
	if err != nil {
		return nil, err
	}

	return &VulnStats{
		Total:         sumValues(counts),
		Critical:      counts["critical"],
		High:          counts["high"],
		Medium:        counts["medium"],
		Low:           counts["low"],
		Info:          counts["info"],
		FalsePositive: counts["false_positive"],
	}, nil
}

// GetPage 获取分页漏洞
func (s *VulnerabilityService) GetPage(ctx context.Context, page, pageSize int) ([]*models.Vulnerability, int, error) {
	if page <= 0 {
		page = 1
	}
	if pageSize <= 0 || pageSize > 500 {
		pageSize = 50
	}
	return s.repo.GetPage(ctx, page, pageSize)
}

// GetPageByFilter 根据过滤条件获取分页漏洞
func (s *VulnerabilityService) GetPageByFilter(ctx context.Context, filter *models.VulnerabilityFilter, page, pageSize int) ([]*models.Vulnerability, int, error) {
	if page <= 0 {
		page = 1
	}
	if pageSize <= 0 || pageSize > 500 {
		pageSize = 50
	}
	return s.repo.GetPageByFilter(ctx, filter, page, pageSize)
}

// VulnStats 漏洞统计
type VulnStats struct {
	Total         int
	Critical      int
	High          int
	Medium        int
	Low           int
	Info          int
	FalsePositive int
}

// HandleEventVulnFound 处理漏洞发现事件
func (s *VulnerabilityService) HandleEventVulnFound(ctx context.Context, data map[string]interface{}) error {
	vulnData, err := extractVulnData(data)
	if err != nil {
		return err
	}

	taskID, err := extractTaskID(data)
	if err != nil {
		return err
	}

	vuln := s.buildVulnerabilityFromData(vulnData, taskID)
	return s.Create(ctx, vuln)
}

// extractVulnData 从事件数据中提取漏洞信息
func extractVulnData(data map[string]interface{}) (map[string]interface{}, error) {
	vulnData, ok := data["vuln"].(map[string]interface{})
	if !ok {
		return nil, errors.InvalidInput("invalid vuln data type")
	}
	return vulnData, nil
}

// extractTaskID 从事件数据中提取任务 ID
func extractTaskID(data map[string]interface{}) (int, error) {
	taskID, ok := data["taskId"].(int)
	if !ok || taskID == 0 {
		if tid, ok := data["taskId"].(float64); ok {
			return int(tid), nil
		}
		return 0, errors.InvalidInput("invalid task id")
	}
	return taskID, nil
}

// buildVulnerabilityFromData 从 Nuclei 输出数据构建漏洞对象
func (s *VulnerabilityService) buildVulnerabilityFromData(vulnData map[string]interface{}, taskID int) *models.Vulnerability {
	templateID := extractStringField(vulnData, "template-id")
	severity := extractStringField(vulnData, "severity")
	name := extractStringField(vulnData, "name")
	url := extractStringField(vulnData, "url")
	matchedAt := extractStringField(vulnData, "matched-at")

	info := extractInfoField(vulnData)
	description := extractDescriptionFromInfo(info)
	tags := extractTagsFromInfo(info)
	reference := extractReferenceFromInfo(info)

	return &models.Vulnerability{
		TaskID:      taskID,
		TemplateID:  templateID,
		Severity:    severity,
		Name:        name,
		Description: description,
		URL:         url,
		MatchedAt:   matchedAt,
		Tags:        tags,
		Reference:   reference,
	}
}

// extractStringField 从数据中提取字符串字段
func extractStringField(data map[string]interface{}, key string) string {
	if val, ok := data[key].(string); ok {
		return val
	}
	return ""
}

// extractInfoField 提取 info 字段
func extractInfoField(data map[string]interface{}) map[string]interface{} {
	if info, ok := data["info"].(map[string]interface{}); ok {
		return info
	}
	return nil
}

// extractDescriptionFromInfo 从 info 中提取描述
func extractDescriptionFromInfo(info map[string]interface{}) string {
	if info == nil {
		return ""
	}
	if desc, ok := info["description"].(string); ok {
		return desc
	}
	return ""
}

// extractTagsFromInfo 从 info 中提取标签
func extractTagsFromInfo(info map[string]interface{}) []string {
	if info == nil {
		return nil
	}

	tagsRaw, ok := info["tags"]
	if !ok {
		return nil
	}

	switch v := tagsRaw.(type) {
	case string:
		if v == "" {
			return nil
		}
		var tags []string
		for _, tag := range strings.Split(v, ",") {
			tag = strings.TrimSpace(tag)
			if tag != "" {
				tags = append(tags, tag)
			}
		}
		return tags

	case []interface{}:
		var tags []string
		for _, tag := range v {
			if tagStr, ok := tag.(string); ok {
				tags = append(tags, tagStr)
			}
		}
		return tags
	}

	return nil
}

// extractReferenceFromInfo 从 info 中提取参考信息
func extractReferenceFromInfo(info map[string]interface{}) []string {
	if info == nil {
		return nil
	}

	refRaw, ok := info["reference"]
	if !ok {
		return nil
	}

	switch v := refRaw.(type) {
	case []interface{}:
		var refs []string
		for _, ref := range v {
			if refStr, ok := ref.(string); ok {
				refs = append(refs, refStr)
			}
		}
		return refs
	case []string:
		return v
	}

	return nil
}

// Update 更新漏洞
func (s *VulnerabilityService) Update(ctx context.Context, id int, isFalsePositive bool, notes string) error {
	if id <= 0 {
		return errors.InvalidInput("invalid vulnerability id")
	}

	// 获取漏洞
	vuln, err := s.repo.GetByID(ctx, id)
	if err != nil {
		return err
	}

	// 更新字段
	vuln.FalsePositive = isFalsePositive
	vuln.Notes = &notes

	return s.repo.Update(ctx, vuln)
}
