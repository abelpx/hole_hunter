package models

// VulnerabilityFilter represents filter options for vulnerability queries
type VulnerabilityFilter struct {
	Page            int      `json:"page"`
	PageSize        int      `json:"pageSize"`
	Severity        []string `json:"severity"`          // 严重程度过滤 (critical, high, medium, low, info)
	TargetID        *int     `json:"target_id"`         // 目标 ID 过滤
	ScanID          *int     `json:"scan_id"`           // 扫描任务 ID 过滤
	IsFalsePositive *bool    `json:"is_false_positive"` // 是否误报过滤
	Tags            []string `json:"tags"`              // 标签过滤
	Search          string   `json:"search"`            // 搜索关键词
}

// Match checks if a vulnerability matches the filter criteria
func (f *VulnerabilityFilter) Match(vuln *Vulnerability) bool {
	// 严重程度过滤
	if len(f.Severity) > 0 {
		found := false
		for _, sev := range f.Severity {
			if vuln.Severity == sev {
				found = true
				break
			}
		}
		if !found {
			return false
		}
	}

	// 目标 ID 过滤（通过 TaskID 过滤）
	if f.TargetID != nil {
		if vuln.TaskID != *f.TargetID {
			return false
		}
	}

	// 扫描任务 ID 过滤
	if f.ScanID != nil {
		if vuln.TaskID != *f.ScanID {
			return false
		}
	}

	// 误报过滤
	if f.IsFalsePositive != nil {
		if vuln.FalsePositive != *f.IsFalsePositive {
			return false
		}
	}

	// 标签过滤
	if len(f.Tags) > 0 {
		found := false
		for _, tag := range f.Tags {
			for _, vtag := range vuln.Tags {
				if vtag == tag {
					found = true
					break
				}
			}
			if !found {
				return false
			}
		}
	}

	// 搜索过滤
	if f.Search != "" {
		searchLower := toLower(f.Search)
		nameMatch := containsLower(vuln.Name, searchLower)
		urlMatch := containsLower(vuln.URL, searchLower)
		descMatch := containsLower(vuln.Description, searchLower)
		if !nameMatch && !urlMatch && !descMatch {
			return false
		}
	}

	return true
}

func toLower(s string) string {
	if s == "" {
		return ""
	}
	// 简单转小写，避免 strings 导入循环
	result := make([]rune, len(s))
	for i, r := range s {
		if r >= 'A' && r <= 'Z' {
			result[i] = r + ('a' - 'A')
		} else {
			result[i] = r
		}
	}
	return string(result)
}

func containsLower(s, substr string) bool {
	s = toLower(s)
	return len(s) >= len(substr) && (s == substr || len(substr) == 0 ||
		(len(s) > 0 && len(substr) > 0 && findSubstring(s, substr)))
}

func findSubstring(s, substr string) bool {
	for i := 0; i <= len(s)-len(substr); i++ {
		if s[i:i+len(substr)] == substr {
			return true
		}
	}
	return false
}
